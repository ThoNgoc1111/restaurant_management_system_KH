{% extends "base.html" %}
{% load custom_filters %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-center">Payment</h1>
    <p class="text-center">Please choose your payment method and provide your shipping address details.</p>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Order Details</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order.items.all %}
                    <tr>
                        <td>{{ item.menu_item.name }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>${{ item.menu_item.price }}</td>
                        <td>${{ item.quantity|multiply:item.menu_item.price }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3" class="text-right">Total Price:</th>
                        <th>${{ order.total_price }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <form method="post" action="{% url 'process_payment' order.id %}">
        {% csrf_token %}
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Shipping Address</h5>
                {{ address_form.as_p }}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Choose Payment Method</h5>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment_method" id="cardPayment" value="card" checked>
                    <label class="form-check-label" for="cardPayment">
                        Card Payment
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment_method" id="paypalPayment" value="paypal">
                    <label class="form-check-label" for="paypalPayment">
                        PayPal Payment
                    </label>
                </div>
            </div>
        </div>

        <div id="cardPaymentForm" class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Card Payment</h5>
                {{ card_form.as_p }}
            </div>
        </div>

        <div id="paypalPaymentForm" class="card mb-4" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">PayPal Payment</h5>
                <div id="paypal-button-container"></div>
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg">Proceed to Payment</button>
        </div>
    </form>
</div>

<!-- Include the PayPal JavaScript SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=YOUR_SANDBOX_CLIENT_ID&currency=USD"></script>

<script>
    // Render the PayPal button into #paypal-button-container
    paypal.Buttons({

        // Set up the transaction
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: '{{ order.total_price }}'  // Can reference the order total price
                    }
                }]
            });
        },

        // Finalize the transaction
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                // Redirect to the payment confirmation page
                window.location.href = "{% url 'payment_confirmation' order.id %}";
            });
        }

    }).render('#paypal-button-container'); // Display the PayPal button

    // Toggle payment forms based on selected payment method
    document.querySelectorAll('input[name="payment_method"]').forEach((elem) => {
        elem.addEventListener("change", function(event) {
            var value = event.target.value;
            if (value === "card") {
                document.getElementById("cardPaymentForm").style.display = "block";
                document.getElementById("paypalPaymentForm").style.display = "none";
            } else if (value === "paypal") {
                document.getElementById("cardPaymentForm").style.display = "none";
                document.getElementById("paypalPaymentForm").style.display = "block";
            }
        });
    });
</script>
{% endblock %}